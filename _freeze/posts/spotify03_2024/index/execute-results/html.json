{
  "hash": "bfb68d399d2ab585fbe857e88d53ed43",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Rでセルフ「Spotifyまとめ2024」\"\nauthor: \"azumaya\"\ndate: \"2024/12/06\"\n# date-modified: \"2024/06/03\"\nformat:\n  html:\n    code-fold: FALSE \n    # code-summary: \"Show the code\"\n    fig.align: \"center\"\n    link-external-newwindow: true\n    tidy: true\n    highlight: \"pygments\"\nimage: fig5.png\ncategories:\n  - R\n  - Analysis\n  - Music\n  - Spotify\n---\n\n\n\n## はじめに\n\n年末になるとSpotifyが1年聴いた音楽のまとめを教えてくれる。割と楽しみにしているあれを自力でやってみよう。\n\n今回は2024年1月から11月の聴取歴を可視化し、ついでに今年の音楽思い出話をする。\n\n![](fig1.jpg){width=\"30%\"}\n\n## データの取得\n\n### 申請\n\nSpotifyでは、お願いするとストリーミング履歴を提供してくれる。\n\n[Spotifyアカウントのプライバシーのページ](https://www.spotify.com/jp/account/privacy/)にアクセスして、**「お客様のデータのダウンロード」**から**「長期ストリーミング履歴」**の申請をする。\n\n\n![](fig2.png){width=\"40%\"}\n\n\n::: {.callout-tip appearance=\"simple\"}\n最大30日間かかるとのことだけど、私は寝て起きたら届いていた。\n:::\n\n### ダウンロード\n\nダウンロードしたzipファイルを開くとこんな感じ。\n\n![](fig3.png){width=\"60%\"}\n\n変数の説明用のpdfファイル、楽曲情報のjsonファイル、ビデオ情報（動画コンテンツ？中身見たけどよくわからず）のjsonファイルが入っている。\n\n::: {.callout-tip appearance=\"simple\"}\n私はSpotifyの登録が2022年、本格的に使い始めたのは2023年なので、これくらいのデータサイズ。\\\nもっと量が多いと、ダウンロードまでに時間がかかるのかも？\n:::\n\n### jsonってなんだ？\n\njsonファイルをよく知らないので、とりあえず開いてみる。\n\n![](fig4.png){width=\"70%\"}\n\nなるほど、構成要素はデータフレームと似ていて直感的。\n\n## データの読み込み\n\n今回使うパッケージはこちら。\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npacman::p_load(tidyverse, \n               jsonlite, # jsonファイルの読み込み \n               lubridate, # タイムスタンプの処理\n               ggfittext # グラフにテキストを追加\n               )\n```\n:::\n\n\n\n`jsonlite`パッケージを使ってデータを読み込む。\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# データが分割されているのでそれぞれ読み込み\ndata1 <- fromJSON(\"Spotify Extended Streaming History/Streaming_History_Audio_2022-2024_0.json\")\ndata2 <- fromJSON(\"Spotify Extended Streaming History/Streaming_History_Audio_2024_1.json\")\n```\n:::\n\n\n\nいつものデータフレームの感じで読み込めている！\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhead(data2)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n                    ts platform ms_played conn_country         ip_addr\n1 2024-09-03T07:50:02Z      ios    194866           JP 123.223.202.114\n2 2024-09-03T07:53:24Z      ios    201040           JP 123.223.202.114\n3 2024-09-03T07:55:54Z      ios    150013           JP 123.223.202.114\n4 2024-09-03T07:59:01Z      ios    187680           JP 123.223.202.114\n5 2024-09-03T08:02:18Z      ios    196560           JP 123.223.202.114\n6 2024-09-03T08:05:48Z      ios    210693           JP 123.223.202.114\n         master_metadata_track_name master_metadata_album_artist_name\n1                    けだものだもの                         Creep Hyp\n2                  キャンバスライフ                         Creep Hyp\n3       テレビサイズ - TV Size 2'30                         Creep Hyp\n4 誰かが吐いた唾が キラキラ輝いてる                         Creep Hyp\n5                          愛の点滅                         Creep Hyp\n6                    リバーシブルー                         Creep Hyp\n  master_metadata_album_album_name                    spotify_track_uri\n1                           世界観 spotify:track:5J6bELLFVOTRuTcFv9ZZTm\n2                           世界観 spotify:track:4xHG2vYSNdqhCxVV6sGNKs\n3                           世界観 spotify:track:5artCEngkKKpKhcbr7Ia3s\n4                           世界観 spotify:track:5mbUBBzsJY2JsE4Qj2GI63\n5                           世界観 spotify:track:3BlYaUK1Aj8G75fiVUkgfl\n6                           世界観 spotify:track:66vlDAwwNitDMwARA8lejR\n  episode_name episode_show_name spotify_episode_uri reason_start reason_end\n1         <NA>              <NA>                <NA>    trackdone  trackdone\n2         <NA>              <NA>                <NA>    trackdone  trackdone\n3         <NA>              <NA>                <NA>    trackdone  trackdone\n4         <NA>              <NA>                <NA>    trackdone  trackdone\n5         <NA>              <NA>                <NA>    trackdone  trackdone\n6         <NA>              <NA>                <NA>    trackdone  trackdone\n  shuffle skipped offline offline_timestamp incognito_mode\n1   FALSE   FALSE   FALSE        1725349607          FALSE\n2   FALSE   FALSE   FALSE        1725349802          FALSE\n3   FALSE   FALSE   FALSE        1725350003          FALSE\n4   FALSE   FALSE   FALSE        1725350153          FALSE\n5   FALSE   FALSE   FALSE        1725350341          FALSE\n6   FALSE   FALSE   FALSE        1725350538          FALSE\n```\n\n\n:::\n:::\n\n\n\n## データの整形\n\nタイムスタンプ列`ts`はUTC（協定世界時）なので、日本時間に変換する。 今回は、`lubridate`パッケージを使う。\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# とりあえず使ってみる\nas_datetime(\"2024-09-03T07:50:02Z\", tz = \"Asia/Tokyo\")\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nDate in ISO8601 format; converting timezone from UTC to \"Asia/Tokyo\".\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"2024-09-03 16:50:02 JST\"\n```\n\n\n:::\n:::\n\n\n\nかしこい！日本時間に変換して、月・日付・時間に分解してみる。\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata2 %>% \n  filter(ms_played >= 60000) %>%\n  mutate(ts = as_datetime(ts, tz = \"Asia/Tokyo\"), # JST勝手に消えててラッキー！\n         month = str_sub(ts, start = 6, end = 7), # 適当ですみません\n         date = str_sub(ts, start = 1, end = 10),\n         time = str_sub(ts, start = 12, end = 20)) %>% \n  select(ts, month, date, time) %>% \n  head()\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nDate in ISO8601 format; converting timezone from UTC to \"Asia/Tokyo\".\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\n                   ts month       date     time\n1 2024-09-03 16:50:02    09 2024-09-03 16:50:02\n2 2024-09-03 16:53:24    09 2024-09-03 16:53:24\n3 2024-09-03 16:55:54    09 2024-09-03 16:55:54\n4 2024-09-03 16:59:01    09 2024-09-03 16:59:01\n5 2024-09-03 17:02:18    09 2024-09-03 17:02:18\n6 2024-09-03 17:05:48    09 2024-09-03 17:05:48\n```\n\n\n:::\n:::\n\n\n\nこれを踏まえて、いろいろ調整してデータを整形。\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata <- bind_rows(data1, data2) %>% \n  filter(ms_played >= 60000, # 1分（=60000ミリ秒）以上聴いた曲のみ抽出\n         is.na(episode_name) # ポッドキャストは除外\n         ) %>%\n  mutate(ts = as_datetime(ts, tz = \"Asia/Tokyo\"), # JSTに変換\n         month = str_sub(ts, start = 6, end = 7),\n         date = str_sub(ts, start = 1, end = 10),\n         time = str_sub(ts, start = 12, end = 20)) %>% \n  rename(artist = master_metadata_album_artist_name) %>% # 列名長いので変換\n  filter(date >= \"2024-01-01\", date < \"2024-12-01\") # 2024年1-11月だけ抽出\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nDate in ISO8601 format; converting timezone from UTC to \"Asia/Tokyo\".\n```\n\n\n:::\n:::\n\n\n\nこのコードをコピペして分析しちゃおう。\n\n## 可視化\n\nこの時期はこのアーティストをよく聴いたな～という体感があるので、月ごとでよく聴いたアーティストを調べてみる。\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 描画用データ\ndata_plt <- data %>% \n  # アーティストごとの月合計再生時間\n  group_by(month, artist) %>% \n  summarise(ms_played_month_artist = sum(ms_played),\n            .groups = \"drop\") %>% \n  \n  # 月合計再生時間\n  group_by(month) %>%\n  mutate(ms_played_month = sum(ms_played_month_artist)) %>%\n  ungroup() %>% \n  arrange(desc(ms_played_month_artist)) %>% \n  \n  # 単位をミリ秒から時間に変換\n  mutate(hour_played_month = ms_played_month / 3600000,\n         hour_played_month_artist = ms_played_month_artist / 3600000) %>%\n  \n  # 月ごとに\n  group_by(month) \n```\n:::\n\n\n\n毎月の合計再生時間と、よく聴いたアーティストのトップ5を可視化してみる。\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata_plt %>%  \n  slice(1:5) %>% # 再生回数多い順に5行\n  ggplot() + \n  geom_col(aes(x = month, y = hour_played_month)) +\n  geom_col(aes(x = month, y = hour_played_month_artist, \n               fill = artist)\n           ,color = \"white\") +\n  labs(x = \"月\", y = \"再生時間（時間）\", fill = \"\") +\n  theme_minimal() +\n  theme(legend.position = \"bottom\") # theme_minimal()より後に持ってこないと適用されない\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-8-1.png){width=960}\n:::\n:::\n\n\n\nいろいろ聴いている。色分けしてもアーティストがよくわからないので、トップ3に絞ってテキストを追加する。\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata_plt %>% \n  slice(1:3) %>% \n  ggplot(aes(x = month, y = hour_played_month_artist, \n             fill = artist,\n             label = artist)) + \n  geom_col(color = \"white\") +\n  geom_bar_text(reflow = TRUE, position = \"stack\") + # 棒グラフにテキストを追加\n  labs(x = \"月\", y = \"再生時間（時間）\", fill = \"\") +\n  theme_minimal() +\n  theme(legend.position = \"bottom\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-9-1.png){width=1152}\n:::\n:::\n\n\n\nいい感じです。本当は再生回数が多い順に積み上げたかった。\n\n\n::: {.callout-note icon=false collapse=true}\n\n### 雑談\n\n**Lamp** \\\n去年の夏にはまってから、しばらく聴いていた。とても柔らかくて、好きです。\n\n**吉田美奈子** \\\nずっと前にラジオで[扉の冬](https://open.spotify.com/intl-ja/track/0mRLWYEDx8Kf5xYt7UnFwC?si=459dba0094394c18)\nを聴いて惚れたけど、1月放送のNHK「おげんさんといっしょ」で\n[頬に夜の灯](https://open.spotify.com/intl-ja/track/4M245xPGlW3WNuijduErTj?si=099b3175ed3b46a8)\nと[恋は流星](https://open.spotify.com/intl-ja/track/2NGWAXh6sisNpVHIAAlME0?si=06095da215cc46de)が流れて、かっけ～～～～～！ってなってからずっと聴いてた。\n\n**sumika** \\\n4月のライブが良すぎて良すぎて。roof sessionを経て間違いなく史上最高になっていた。[運命](https://open.spotify.com/intl-ja/track/3qyqpWcRKyundtraHd65hq?si=fad4a842121b4db8)が良い。\n\n**the band apart** \\\n忘れたころに引っ張り出してアルバムをリピートしている。6月は、2006年発売の[3rdアルバム](https://open.spotify.com/intl-ja/album/2unU7MUhpbs2VP9EsxgQyy?si=b6iDlsnfQiG99W9pBLDqYw)全曲やりますツアーに行けて、感無量だった。\n\n**ME:I** \\\n[Sugar Bomb](https://open.spotify.com/intl-ja/track/2n7RsaMrg4IrKeSmPlBNxF?si=811f57f1b7e64d3d)を永遠リピート。\n\n**Chilli Beans.** \\\n突如はまって緑黄色社会との対バンに行った。キュートだった。\n\n**Norah Jones** \\\n昔から好き。この時期は朝起きたらとりあえず[Sunrise](https://open.spotify.com/intl-ja/track/7zkLpY72g6lKQbiHDqri1S?si=ef8e3524814e4cfa)を流していた。\n\n**Judee Shill** \\\nお気に入りの喫茶店で流れていたラジオ「SPITZ 草野マサムネのロック大陸漫遊記」でマサムネさんが紹介していて、これ父が好きそうだなーと思ったら親子ではまった。3枚しかアルバムないのに全部良い。Spotify上で今年一番聴いた曲は[Lopin' Along Thru the Cosmos](https://open.spotify.com/intl-ja/track/5qpWttDHZuzfoHuBIX5kRd?si=b181a3b533ea4ff1)だった。\n\n**スピッツ** \\\n2月はツアー、8月はフェスなのでよく聴いてた。フェスで初めて生で聴いた[ハチミツ](https://open.spotify.com/intl-ja/track/70nggNK0Gg2IWSLinNl5LT?si=94b82af463c44762)が良すぎて過去曲をたくさん聴いてた。\n\n**クリープハイプ** \\\n一番聴いた！\n8月のフェス「RISING SUN ROCK FESTIVAL」の大トリ、朝4時のステージがなんかよかったな…と引っかかっていて、特に印象に残った[火まつり](https://open.spotify.com/intl-ja/track/3IWztt3qxGNnfwjZFe58rB?si=9b1e9c4351dc48af)（ベースの人歌うの～！？）と[二十九、三十](https://open.spotify.com/intl-ja/track/1CGjCodg0z4CeYzyTY75lQ?si=2af444a0c6984e06)（最後に染みた）をきっかけにドはまり。この時期はとりあえず全曲聴いて、アルバム1枚ずつ回していく数週間だった。 \\\nちょうどそのステージで「今年中にアルバム出します」と情報を初出ししていて、ファンの人はうれしいだろうなぁと思っていたけど、私がファンになりました。新譜めでたい！ツアーも当選してすごく嬉しい。\n\n**おいしくるメロンパン** \\\nここ数年のツアーは欠かさず行っていて、毎回、今が一番いいなと思いながら聴いている。今回も最高だった。曲数が増えてきたので全曲プレイリストを作ってひたすら。\n\n**Starbuck** \\\n友達に勧められたのを思い出して久しぶりにリピートしていた。いいマリンバ。\n\n**梅田サイファー** \\\n友達（↑同一人物）に誘われたので最新アルバムを予習してライブハウスへ。初めての世界だったけど信じられないくらい楽しかった。ステージとフロアの様子がかなり脳裏に焼き付いていて、あの光景を思い出してはよかったなぁと噛みしめている。しばらく忘れたくない。自分がラップ好きになるとは。。\n\n**Kroi** \\\n8月のフェス以降ちょいちょい聴いていたけど、最新曲の[Jewel](https://open.spotify.com/intl-ja/track/2rSEqTiael70xKZGecoej6?si=d7a6057b81454c3a)が意外な音で、再び聴いている。\n\n**藤井風** \\\n[スタジアムライブ](https://open.spotify.com/intl-ja/album/0U55vgfligIVp8fFNSu2Xf?si=l9Vo6nA9TSyr_JTxGtFA3w)が良すぎて、元々好きだった[ガーデン](https://open.spotify.com/intl-ja/track/6LcX2E4Ha1SNi92bfSrFtM?si=69cae7347ea44998)がさらに好きになる。\n\nキリンジ/KIRINJI、星野源はいつでもよく聴いている。他にいろんなアーティストを聴きつつ、たびたび戻っている。\n:::\n\n\n<br/>\n\n\n<iframe style=\"border-radius:12px\" src=\"https://open.spotify.com/embed/playlist/37i9dQZF1FoyQGyinuuvRu?utm_source=generator\" width=\"100%\" height=\"352\" frameBorder=\"0\" allowfullscreen=\"\" allow=\"autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture\" loading=\"lazy\"></iframe>\n\n## おわりに\n\n月ごとトップ3アーティストの17組のうち、6組は今年からちゃんと聴き始めたことになる。ずっと好きなアーティストがいつつ、新しい音楽にも出会えているのがわかって良かった。\n\nこれだけ情報量の多いデータなので、いろいろなことができそうです。友達のも見てみたい。\n\n\n\n## 参考\n\n[Rでunix時間からJSTに変更する際はas_datetime()](https://dichika.hateblo.jp/entry/2019/10/07/141611)\n\n[Introduction to ‘ggfittext’](https://cran.r-project.org/web/packages/ggfittext/vignettes/introduction-to-ggfittext.html)\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}